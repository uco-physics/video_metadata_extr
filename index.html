<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Video Metadata Viewer</title>
    <style>
      /* スタイルガイド: Google HTML/CSS Style Guide を採用。シンプルで読みやすく、クラス名はハイフン区切り。 */
      html,
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }
      body * {
        box-sizing: border-box;
      }
      #wrapper {
        display: flex;
        flex-direction: column;
        height: 100vh;
        padding: 16px;
        width: 100%;
      }
      #file-input {
        padding-bottom: 16px;
      }
      #output-container {
        flex: 1;
        overflow: auto;
        border: 1px solid #ccc;
        padding: 8px;
        background-color: #f9f9f9;
      }
      #output {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      #controls {
        display: flex;
        justify-content: space-between;
        padding: 16px 0;
      }
      #debug-toggle {
        margin-right: 8px;
      }
      #error-message {
        color: red;
        display: none;
      }
    </style>
    <script type="text/javascript" src="https://unpkg.com/mediainfo.js"></script>
  </head>
  <body>
    <div id="wrapper">
      <input type="file" id="file-input" name="file-input" accept=".mp4,.wav" />
      <div id="controls">
        <button id="copy-button" disabled>JSONをコピー</button>
        <button id="download-button" disabled>TXTとしてダウンロード</button>
        <label>
          <input type="checkbox" id="debug-toggle" /> デバッグモード
        </label>
      </div>
      <div id="output-container">
        <pre id="output"></pre>
        <div id="error-message"></div>
      </div>
    </div>
    <script type="text/javascript">
      // コーディング規約: Airbnb JavaScript Style Guide を採用。変数名はcamelCase、定数はUPPER_CASE、インデントは2スペース。
      // 標準規格: ECMAScript 2020 (ES11) を基準に、ブラウザ互換性を考慮。
      // デザインパターン: モジュールパターン (Revealing Module Pattern) を使用して、拡張性を確保。API化しやすくするため、公開メソッドを定義。
      // コメント: 全て日本語で記述。JSDocスタイルを一部採用し、資産化を容易に。
      // 工夫: 関数を細かく分割し、エラーハンドリングを集中。デバッグモードで詳細エラーを表示。将来の拡張のため、MediaInfoのオプションをオブジェクトで管理。

      const MetadataViewer = (function () {
        // プライベート変数: 状態管理
        let mediaInfoInstance = null;
        let isDebugMode = false;
        let currentResult = null;

        // 定数: エラーメッセージ
        const ERROR_FAILED = 'メタデータの取得に失敗しました。';

        /**
         * MediaInfoインスタンスを初期化。
         * @returns {Promise} MediaInfoインスタンスのPromise。
         */
        async function initMediaInfo() {
          try {
            // オプション: 拡張性を考慮し、オブジェクトで管理。将来的にカスタムパスやフォーマットを追加可能。
            const options = {
              format: 'JSON', // JSON形式で出力。詳細なメタデータを取得。
              full: true, // 全ての内部タグを表示。
            };
            mediaInfoInstance = await mediaInfoFactory(options);
            return mediaInfoInstance;
          } catch (error) {
            handleError(error, 'MediaInfo初期化時');
          }
        }

        /**
         * ファイルを解析してメタデータを取得。
         * @param {File} file - 解析対象のファイル。
         * @returns {Promise<string>} JSON文字列のPromise。
         */
        async function analyzeFile(file) {
          if (!mediaInfoInstance) {
            await initMediaInfo();
          }

          const fileSize = file.size;
          const readChunk = async (chunkSize, offset) => {
            try {
              const buffer = await file.slice(offset, offset + chunkSize).arrayBuffer();
              return new Uint8Array(buffer);
            } catch (error) {
              handleError(error, 'チャンク読み込み時');
            }
          };

          try {
            const result = await mediaInfoInstance.analyzeData(fileSize, readChunk);
            currentResult = result;
            return result;
          } catch (error) {
            handleError(error, 'データ解析時');
          } finally {
            // インスタンスを保持して再利用。close()はアプリ終了時のみ。将来的に拡張。
          }
        }

        /**
         * エラーを処理し、表示。
         * @param {Error} error - エラーオブジェクト。
         * @param {string} location - エラーが発生した場所。
         */
        function handleError(error, location) {
          const output = document.getElementById('output');
          const errorMessage = document.getElementById('error-message');
          output.textContent = '';
          errorMessage.style.display = 'block';
          errorMessage.textContent = ERROR_FAILED;
          if (isDebugMode) {
            errorMessage.textContent += `\nエラー発生箇所: ${location}\n詳細: ${error.stack || error.message}`;
          }
          throw error; // 呼び出し元でキャッチ可能。
        }

        /**
         * ファイル変更時のハンドラ。
         */
        async function onFileChange() {
          const fileInput = document.getElementById('file-input');
          const output = document.getElementById('output');
          const errorMessage = document.getElementById('error-message');
          const copyButton = document.getElementById('copy-button');
          const downloadButton = document.getElementById('download-button');

          errorMessage.style.display = 'none';
          output.textContent = '処理中...';

          const file = fileInput.files[0];
          if (!file) return;

          try {
            const result = await analyzeFile(file);
            output.textContent = result;
            copyButton.disabled = false;
            downloadButton.disabled = false;
          } catch (error) {
            // handleErrorで既に処理済み。
            copyButton.disabled = true;
            downloadButton.disabled = true;
          }
        }

        /**
         * JSONをコピー。
         */
        function copyToClipboard() {
          if (!currentResult) return;
          navigator.clipboard.writeText(currentResult).then(() => {
            alert('JSONをクリップボードにコピーしました。');
          }).catch((error) => {
            handleError(error, 'コピー時');
          });
        }

        /**
         * TXTとしてダウンロード。
         */
        function downloadAsTxt() {
          if (!currentResult) return;
          const blob = new Blob([currentResult], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'metadata.txt';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }

        /**
         * デバッグモードのトグル。
         */
        function toggleDebugMode(event) {
          isDebugMode = event.target.checked;
          // エラーが既に表示されている場合、再表示。
          if (document.getElementById('error-message').style.display === 'block') {
            document.getElementById('error-message').textContent = ERROR_FAILED;
            if (isDebugMode) {
              // 詳細を追加（エラーが保持されていない場合、簡易表示）。
              document.getElementById('error-message').textContent += '\nデバッグモード有効: 詳細はコンソールを確認。';
              console.error('デバッグログ:', currentResult || 'なし');
            }
          }
        }

        /**
         * 初期化とイベントリスナーの設定。
         */
        function init() {
          const fileInput = document.getElementById('file-input');
          const copyButton = document.getElementById('copy-button');
          const downloadButton = document.getElementById('download-button');
          const debugToggle = document.getElementById('debug-toggle');

          fileInput.addEventListener('change', onFileChange);
          copyButton.addEventListener('click', copyToClipboard);
          downloadButton.addEventListener('click', downloadAsTxt);
          debugToggle.addEventListener('change', toggleDebugMode);

          // 初期化時にMediaInfoをプリロード（オプション）。
          initMediaInfo().catch(() => {}); // サイレント失敗。
        }

        // 公開API: 拡張時に外部から呼び出し可能。
        return {
          init,
          analyzeFile, // API化のため公開。
          close: () => mediaInfoInstance && mediaInfoInstance.close(),
        };
      })();

      // アプリ起動。
      MetadataViewer.init();
    </script>
  </body>
</html>
