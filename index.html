<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ビデオメタデータビューアー</title>
  <style>
    /* 基本スタイル: シンプルでレスポンシブなデザイン */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background-color: #f4f4f4;
    }
    #wrapper {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    #fileInput {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #output {
      width: 100%;
      height: 400px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      font-family: monospace;
      background-color: white;
    }
    #errorLog {
      display: none;
      color: red;
      padding: 8px;
      border: 1px solid red;
      border-radius: 4px;
      background-color: #ffe6e6;
    }
    #debugToggle:checked ~ #errorLog {
      display: block;
    }
  </style>
</head>
<body>
  <div id="wrapper">
    <h1>ビデオメタデータビューアー</h1>
    <input type="file" id="fileInput" accept=".mp4,.wav">
    <div id="controls">
      <button id="copyButton" disabled>メタデータをコピー</button>
      <button id="downloadButton" disabled>TXTとしてダウンロード</button>
      <label><input type="checkbox" id="debugToggle"> デバッグモード</label>
    </div>
    <textarea id="output" readonly>ここにメタデータが表示されます...</textarea>
    <div id="errorLog"></div>
  </div>

  <script type="text/javascript" src="https://unpkg.com/mediainfo.js"></script>
  <script>
    // モジュールパターンでコードを構造化
    const VideoMetadataViewer = (function () {
      // プライベート変数
      let mediaInfoInstance = null;
      let isProcessing = false;

      // DOM要素のキャッシュ
      const elements = {
        fileInput: document.getElementById('fileInput'),
        output: document.getElementById('output'),
        errorLog: document.getElementById('errorLog'),
        copyButton: document.getElementById('copyButton'),
        downloadButton: document.getElementById('downloadButton'),
        debugToggle: document.getElementById('debugToggle'),
      };

      // 初期化処理
      async function init() {
        try {
          // MediaInfo.jsのインスタンスを作成
          mediaInfoInstance = await window.mediaInfoFactory({ format: 'JSON' });
          elements.fileInput.addEventListener('change', handleFileChange);
          elements.copyButton.addEventListener('click', copyMetadata);
          elements.downloadButton.addEventListener('click', downloadMetadata);
          elements.debugToggle.addEventListener('change', toggleDebugMode);
          enableButtons(false);
        } catch (error) {
          logError('MediaInfo初期化エラー', error);
        }
      }

      // ファイル変更ハンドラ
      async function handleFileChange(event) {
        if (isProcessing) return; // 重複処理防止
        isProcessing = true;
        enableButtons(false);

        const file = event.target.files[0];
        if (!file) {
          logError('ファイルが選択されていません');
          isProcessing = false;
          return;
        }

        try {
          const readChunk = async (chunkSize, offset) =>
            new Uint8Array(await file.slice(offset, offset + chunkSize).arrayBuffer());
          const result = await mediaInfoInstance.analyzeData(file.size, readChunk);
          displayMetadata(result);
          enableButtons(true);
        } catch (error) {
          logError('メタデータ取得エラー', error);
          displayMetadata('メタデータの取得に失敗しました。');
        } finally {
          isProcessing = false;
        }
      }

      // メタデータ表示
      function displayMetadata(data) {
        elements.output.value = typeof data === 'string' ? data : JSON.stringify(JSON.parse(data), null, 2);
      }

      // エラーログ
      function logError(message, error = {}) {
        const errorMessage = `${message}\n詳細: ${error.message || '不明'}\nスタック: ${error.stack || 'なし'}`;
        elements.errorLog.textContent = errorMessage;
        if (!elements.debugToggle.checked) {
          elements.errorLog.style.display = 'none';
        }
      }

      // ボタンの有効/無効化
      function enableButtons(enabled) {
        elements.copyButton.disabled = !enabled;
        elements.downloadButton.disabled = !enabled;
      }

      // メタデータコピー
      function copyMetadata() {
        navigator.clipboard.writeText(elements.output.value)
          .then(() => alert('メタデータをクリップボードにコピーしました！'))
          .catch((error) => logError('コピーエラー', error));
      }

      // メタデータダウンロード
      function downloadMetadata() {
        const blob = new Blob([elements.output.value], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'metadata.txt';
        a.click();
        URL.revokeObjectURL(url);
      }

      // デバッグモードトグル
      function toggleDebugMode() {
        elements.errorLog.style.display = elements.debugToggle.checked ? 'block' : 'none';
      }

      // 公開API
      return {
        init,
      };
    }());

    // アプリケーション起動
    VideoMetadataViewer.init();
  </script>
</body>
</html>
