<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Metadata Viewer</title>
  <style>
    /* BEM命名規則を採用したCSS */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f9;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .input__file {
      margin-bottom: 20px;
    }
    .input__debug-toggle {
      margin-bottom: 20px;
    }
    .output__json {
      background: #f8f8f8;
      padding: 15px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: monospace;
    }
    .output__debug {
      background: #ffe6e6;
      padding: 15px;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: monospace;
      display: none;
    }
    .button {
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    .button:hover {
      background-color: #0056b3;
    }
    .error {
      color: #dc3545;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ビデオメタデータビューア</h1>
    <label class="input__debug-toggle">
      <input type="checkbox" id="debugToggle"> デバッグモード
    </label>
    <input type="file" class="input__file" accept=".mp4,.wav" />
    <div class="output__json" id="jsonOutput"></div>
    <div class="output__debug" id="debugOutput"></div>
    <button class="button" id="copyButton" disabled>JSONをコピー</button>
    <button class="button" id="downloadButton" disabled>TXTとしてダウンロード</button>
    <button class="button" id="copyDebugButton" disabled>デバッグ情報をコピー</button>
    <div class="error" id="errorMessage"></div>
  </div>

  <script type="text/javascript" src="https://unpkg.com/mediainfo.js"></script>
  <script>
    // モジュールパターンでコードを構造化
    const MetadataViewer = (function() {
      // プライベート変数
      const fileInput = document.querySelector('.input__file');
      const debugToggle = document.querySelector('#debugToggle');
      const jsonOutput = document.querySelector('#jsonOutput');
      const debugOutput = document.querySelector('#debugOutput');
      const copyButton = document.querySelector('#copyButton');
      const downloadButton = document.querySelector('#downloadButton');
      const copyDebugButton = document.querySelector('#copyDebugButton');
      let isDebugMode = false;
      let mediaInfo = null;

      // デバッグログを追加
      function logDebug(step, message, error = null) {
        if (!isDebugMode) return;
        const timestamp = new Date().toLocaleTimeString('ja-JP');
        let log = `[${timestamp}] ${step}: ${message}`;
        if (error) {
          log += `\n詳細: ${error.message}\nスタックトレース: ${error.stack || 'なし'}`;
        }
        debugOutput.textContent += log + '\n\n';
        debugOutput.style.display = 'block';
        copyDebugButton.disabled = false;
      }

      // MediaInfoの初期化
      async function initializeMediaInfo() {
        try {
          logDebug('初期化', 'MediaInfoライブラリをロード開始');
          if (!window.mediaInfoFactory) {
            throw new Error('mediaInfoFactoryがロードされていません');
          }
          mediaInfo = await window.mediaInfoFactory({ format: 'JSON', full: true });
          logDebug('初期化', 'MediaInfoライブラリをロード完了');
        } catch (error) {
          logDebug('初期化エラー', 'MediaInfoライブラリのロードに失敗', error);
          throw error;
        }
      }

      // メタデータ抽出処理
      async function extractMetadata(file) {
        try {
          // エラーメッセージとデバッグ出力をクリア
          errorMessage.textContent = '';
          debugOutput.textContent = '';
          jsonOutput.textContent = 'メタデータを取得中...';
          logDebug('初期化', 'メタデータ抽出プロセスを開始');

          // ファイルの検証
          if (!file) {
            throw new Error('ファイルが選択されていません');
          }
          logDebug('ファイル検証', `ファイル名: ${file.name}, タイプ: ${file.type}`);

          // サポートされた形式か確認
          if (file.type !== 'video/mp4' && file.type !== 'audio/wav') {
            throw new Error('サポートされていないファイル形式です');
          }

          // MediaInfoが未初期化の場合、初期化
          if (!mediaInfo) {
            await initializeMediaInfo();
          }

          // ファイルサイズを取得
          const fileSize = file.size;
          logDebug('ファイル読み込み', `ファイルサイズ: ${fileSize} バイト`);

          // readChunk関数を定義
          async function readChunk(chunkSize, offset) {
            logDebug('ファイル読み込み', `チャンク読み込み: offset=${offset}, size=${chunkSize}`);
            const buffer = await file.slice(offset, offset + chunkSize).arrayBuffer();
            return new Uint8Array(buffer);
          }

          // MediaInfoでメタデータを取得
          logDebug('メタデータ取得', 'MediaInfoでメタデータ抽出開始');
          const result = await mediaInfo.analyzeData(fileSize, readChunk);
          logDebug('メタデータ取得', 'メタデータ抽出完了');

          // メタデータを表示
          const metadata = JSON.parse(result); // JSON文字列をパース
          const formattedMetadata = JSON.stringify(metadata, null, 2);
          jsonOutput.textContent = formattedMetadata;
          copyButton.disabled = false;
          downloadButton.disabled = false;
          logDebug('表示', 'メタデータをJSON形式で表示完了');

          return formattedMetadata;
        } catch (error) {
          // エラーハンドリング
          console.error('メタデータ取得エラー:', error);
          logDebug('エラー', 'メタデータ取得中にエラーが発生', error);
          errorMessage.textContent = `エラー: メタデータの取得に失敗しました（${error.message}）`;
          jsonOutput.textContent = '';
          copyButton.disabled = true;
          downloadButton.disabled = true;
          copyDebugButton.disabled = !isDebugMode;
        }
      }

      // JSONをクリップボードにコピー
      function copyToClipboard() {
        const text = jsonOutput.textContent;
        if (text) {
          navigator.clipboard.writeText(text)
            .then(() => {
              alert('JSONをクリップボードにコピーしました');
              logDebug('コピー', 'JSONをクリップボードにコピー完了');
            })
            .catch(err => {
              console.error('コピー失敗:', err);
              logDebug('コピーエラー', 'JSONのコピーに失敗', err);
              errorMessage.textContent = 'エラー: コピーに失敗しました';
            });
        }
      }

      // デバッグ情報をクリップボードにコピー
      function copyDebugToClipboard() {
        const text = debugOutput.textContent;
        if (text) {
          navigator.clipboard.writeText(text)
            .then(() => {
              alert('デバッグ情報をクリップボードにコピーしました');
              logDebug('デバッグコピー', 'デバッグ情報をクリップボードにコピー完了');
            })
            .catch(err => {
              console.error('デバッグコピー失敗:', err);
              logDebug('デバッグコピーエラー', 'デバッグ情報のコピーに失敗', err);
              errorMessage.textContent = 'エラー: デバッグ情報のコピーに失敗しました';
            });
        }
      }

      // TXTファイルとしてダウンロード
      function downloadAsTxt() {
        const text = jsonOutput.textContent;
        if (text) {
          const blob = new Blob([text], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'metadata.txt';
          a.click();
          URL.revokeObjectURL(url);
          logDebug('ダウンロード', 'メタデータをTXTとしてダウンロード完了');
        }
      }

      // イベントリスナーの設定
      function init() {
        fileInput.addEventListener('change', async (event) => {
          const file = event.target.files[0];
          if (file && (file.type === 'video/mp4' || file.type === 'audio/wav')) {
            await extractMetadata(file);
          } else {
            errorMessage.textContent = 'エラー: MP4またはWAVファイルを選択してください';
            jsonOutput.textContent = '';
            debugOutput.textContent = '';
            copyButton.disabled = true;
            downloadButton.disabled = true;
            copyDebugButton.disabled = true;
            logDebug('ファイル選択エラー', '不正なファイル形式が選択されました');
          }
        });

        copyButton.addEventListener('click', copyToClipboard);
        downloadButton.addEventListener('click', downloadAsTxt);
        copyDebugButton.addEventListener('click', copyDebugToClipboard);

        debugToggle.addEventListener('change', (event) => {
          isDebugMode = event.target.checked;
          debugOutput.style.display = isDebugMode ? 'block' : 'none';
          copyDebugButton.style.display = isDebugMode ? 'inline-block' : 'none';
          logDebug('デバッグモード', `デバッグモードを${isDebugMode ? 'ON' : 'OFF'}に切り替え`);
        });
      }

      // MediaInfoのクリーンアップ
      function cleanup() {
        if (mediaInfo) {
          mediaInfo.close();
          mediaInfo = null;
          logDebug('クリーンアップ', 'MediaInfoインスタンスを閉じました');
        }
      }

      // パブリックAPI
      return {
        init: init,
        extractMetadata: extractMetadata,
        cleanup: cleanup
      };
    })();

    // 初期化
    MetadataViewer.init();

    // ページ離脱時にMediaInfoを閉じる
    window.addEventListener('beforeunload', () => {
      MetadataViewer.cleanup();
    });
  </script>
</body>
</html>
